<div class="content">
    <div class="story-template">
        <div class="story-template__story">
            <div class="story-template__story-head">
                <p><span>In</span>&nbsp;{{ sectionNames }}</p>
                <h1>{{ storyData['headline'] }}</h1>
                <div class="story-template__story-head__author">
                    <div class="author-pic">
                         <img class="author-image" src="{{focusedImageUrl(authorDetails['avatar-s3-key'],config['image-cdn'], [16,9], [], {w: 200})}}"/>
                    </div>
                    <div class="author-box">
                        <p class="author-box__name">By {{authorDetails['name']}}</p>
                        <p class="author-box_detail">{{ (storyData['first-published-at'] // 1000)|date('M d, Y') }}</p>
                    </div>
                </div>
            </div>
            <div class="story-template__story-headimage">
                <img src="{{focusedImageUrl(storyData['hero-image-s3-key'],config['image-cdn'], [16,9], storyData['hero-image-metadata'], {w: 1000})}}" class="story-img"/>
            </div>
            <div class="story-template__story-recipe-preparation-box">
                <ul>
                    <li>Prep Time
                        <br/>
                        <span>{{storyData['metadata']['story-attributes']['preprationtime'][0]}} Minutes</span></li>
                    <li>Cook Time
                        <br/>
                        <span>{{storyData['metadata']['story-attributes']['cookingtime'][0]}} Minutes</span></li>
                    <li>Serving
                        <br/>
                        <span>{{storyData['metadata']['story-attributes']['servings'][0]}} Persons</span></li>
                    <li>Difficulty Level
                        <br/>
                        <span>{{storyData['metadata']['story-attributes']['difficultylevel'][0]}}</span></li>
                </ul>
            </div>
            {% for card in storyCards | slice(0,1)  %}
                <div class="story-template__story-content-story-section">
                       <div class="story-template__story-content-story-section__left">
                          <ul> Ingredients
                              {% for storyElement in card['story-elements'] %}
                              {% for Elements in storyElement['story-elements'] %}
                                  <li>{{Elements['text'] }}</li>
                              {% endfor %}
                              {% endfor %}
                          </ul>
                        </div>
                        <div class="story-template__story-content-story-section__right">
                             <p>Instructions</p>
                             {% for storyElement in card['story-elements'] %}
                              {% if storyElement['subtype'] == null %}
                                  <p>{{ storyElement['text'] | raw }}</p>
                              {% endif %}
                            {% endfor %}

                            {% for card in storyCards | slice(1) %}
                              <div class="card {{ card['metadata']['attributes']['alignment'][0] }}">
                                {% include "story/card" with {'storyElements': card['story-elements'] } %}
                              </div>
                            {% endfor %}

                        </div>
                </div>
            {% endfor %}

            <div class="story-template__story-rate-recipe-section">
                <div class="story-template__story-rate-recipe-section__tab">
                    <ul class="tabs">
                        <li class="tab-item tab-item--active"><a href="javascript:void(0)">Rate This Recipe</a></li>
                    </ul>
                </div>
                <div class="story-template__story-rate-recipe-section__tab-content">
                    <div class="story-template__story-rate-recipe-section__tab-content__imagebox">
                        <img src="http://placehold.it/100x100">
                    </div>
                    <div class="story-template__story-rate-recipe-section__tab-content__ratenow js-rating-widget">
                        <p><span>3 People</span> Rated This Recepie</p>
                        <span class="unrated-stars" id="rating">
                        <span data-rating="1" class="star">★</span>
                        <span data-rating="2" class="star">★</span>
                        <span data-rating="3" class="star">★</span>
                        <span data-rating="4" class="star">★</span>
                        <span data-rating="5" class="star">★</span>
                        </span>
                    </div>
                    <div class="story-template__story-rate-recipe-section__tab-content__already-rated">
                        <p>Average Rating</p>
                        <div class="rated-stars">
                            <span class="star-percentage">★★★★★</span>
                            <span class="star-percentage star-percentage-rated" style="width:{{ratingPercent}}%;">★★★★★</span>
                        </div>
                        <span class="rated-value">{{averageRating}}</span>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>
<!-- content -->

<script>
    var token = '{{ csrf_token() }}';
    var storyId = '{{storyData['story-content-id']}}';
    this.ratingStars = document.querySelectorAll('#rating span');
    function getCookie(name)
    {
      var re = new RegExp(name + "=([^;]+)");
      var value = re.exec(document.cookie);
      return (value != null) ? unescape(value[1]) : null;
    }
    var ratingValue = getCookie(ratingStars);
    console.log(ratingValue);
    for (var i = 0; i < ratingValue ; i++) {
      this.ratingStars[i].classList.add('star-rated');
    }

    $(".star").click(function(){
      // if(){
      //   $(".star").off("click");
      // }
        var rating = $(this).attr("data-rating");
        document.cookie = "ratingStars = "+rating;
        this.ratingStars = document.querySelectorAll('#rating span');
        for (var i = 0; i < rating ; i++) {
          this.ratingStars[i].classList.add('star-rated');
        }
        $(".star").off("click");
        $.ajax({
         type: "POST",
         url: "/api/stories/"+storyId+"/votes",
         data: JSON.stringify({ 'magnitude': parseInt(rating), '_token': token }),
         contentType: 'application/json',
         success: function (data) {

         },
         error: function (data) {
           console.log('Error:', data);
          }
        });
        $.get("/api/stories/"+storyId+"", function(data, status){
          var votes = data.story.votes;
          var numerator = 0; var denominator = 0;
          for (var key in votes) {
            numerator += key * votes[key];
            denominator += votes[key];
          }
          var rating = (numerator/denominator);
          var averageRating = Math.round(rating * 10)/10; var ratingPercent = (averageRating * 100)/5;
          $(".star-percentage-rated").width(ratingPercent+'%');
          $(".rated-value").text(averageRating);
        });
   });
 </script>
